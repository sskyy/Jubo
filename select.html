<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf8">
    <script src="./lib/snap.svg-min.js"></script>
    <script src="./lib/jquery-1.10.2.min.js"></script>
    <script src="./lib/jquery.cookie.js"></script>
    <script src="./lib/underscore-min.js"></script>
    <script src="./lib/head.core.min.js"></script>
    <script src="./lib/moment-with-langs.js"></script>
    <script src="./lib/page.js"></script>
    <script src="./lib/pen/pen.js"></script>
    <script src="./lib/responsiveslides.js"></script>
    <script src="./lib/dropzone.js"></script>
    <link href="./css/main.css" type="text/css" rel="stylesheet"/>
    <link href="./lib/pen/pen.css" type="text/css" rel="stylesheet"/>
</head>
<body ms-controller="general">
    <div id="login" class="Mmodal"  ms-controller="login" ms-if="modalMode=='login'&&user.uid==0">
        <a class="close" ms-click="changeModal">X</a>
        <div class="header">登录/注册</div>
        <div class="message" ms-class="show:message">{{message}}</div>
        <div class="row"><span class="MinputLabel">用户名</span><input class="inputTypical" type="text" ms-duplex="inputUsername"></div>
        <div class="row"><span class="MinputLabel">密码</span><input class="inputTypical"  ms-duplex="inputPassword" type="password" ms-keypress="keypress($event)"></div>
        <div class="footer row"><a class="Mbtn" ms-click="login">登录</a></div>
    </div>
    <div id="Cleft">
        <div class="info">
            <a ms-if="!user.uid" ms-click="changeModal('login')">登录</a>
            <span ms-if="user.uid" class="username">{{user.name}}</span>
            <a ms-if="user.uid" ms-click="logout">退出</a>

        </div>
        <div class="navs">
            <a class="viewMode" href="/event/list">时光旅行</a>
            <a class="viewMode" href="/create/event">创建事件</a>
            <a class="viewMode" href="/create/piece">创建片段</a>
        </div>
    </div>

    <div id="Cright" ms-controller="event">
        <div class="Mloading" ms-if="loading">正在载入数据...</div>
        <div id="Mevent" class="Mpage" ms-class="show:!loading&&(viewMode=='event'||viewMode=='piece'||viewMode=='newPiece')">
            <div id="CdetailPiece">
                <div id="MdetailPiece" ms-class="hide:viewMode!='piece'" ms-controller="detailPiece">
                    <div id="CpieceBody">
                        <div id="MpieceAuthor">
                            <a href="/users/s27zLn" class="author name">
                              <div class="avatar">
                                <img alt="0" src="http://tp3.sinaimg.cn/1221788390/180/1289279591/0">
                              </div>
                              <br>
                                {{author.name}}
                            </a>      
                            <div class="about">
                              <p class="intro">{{author.signature}}</p>
                            </div>
                            <div class="sns">
                              <a href="http://site.douban.com/cctvjz/"><i class="icon-home"></i></a><a href="http://weibo.com/u/1221788390" target="_blank"><img alt="Weibo_48" src="http://assets2.jianshu.io/assets/weibo_48-ecf8fc75c0b7211b0ecad85ce23eb1fe.png"></a><a href="http://www.douban.com/people/23446096" target="_blank"><img alt="Douban_48" src="http://assets3.jianshu.io/assets/douban_48-be5d39195c94e54ddf7077ed2fa27901.png"></a>
                            </div>
                        </div>
                        <div class="MpieceTitle">{{title}}</div>
                        <div id="MpieceMetrics" ms-with="metricsVal">
                            <span class="pieceMetric">
                                <span class="pieceMetricKey">{{$key}}</span><span class="pieceMetricVal">
                                    <span class="pieceMetricValText">{{$val.val}}/{{$val.top}}</span>
                                    <span class="pieceMetricValBarCon">
                                        <span ms-attr-style="'width:'+($val.val*100/$val.top)+'%'" class="pieceMetricValBar"></span>
                                    </span>
                                </span>
                            </span>
                        </div>
                        <div id="MpiecePics" ms-if="pics.length!=0">
                            <ul id="JpiecePicsSlider" class="rslides" ms-each-pic="pics" data-each-rendered="detailPieceRendered">
                                <li class="piecePic">
                                    <img ms-src="'http://127.0.0.1:1337/image/medium/'+pic.id" alt="">
                                    <p class="caption">{{pic.caption}}</p>
                                </li>
                            </ul>
                            <div class="picNav">
                                <span class="picCaption">{{pics[currentPic].caption}}</span>
                                <span class="picIndex">{{currentPic+1}}</span>/<span class="picTotal">{{pics.length}}</span>
                            </div>
                            <div class="slideControllers">
                                <span class="slideController prev"></span>
                                <span class="slideController next"></span>
                            </div>
                        </div>
                        <div id="MpieceContent" ms-html="content"></div>
                    </div>
                </div>

                <div id="newPiece" ms-class="hide:viewMode!='newPiece'" ms-controller="createPiece">
                    <div id="newPieceForm">
                        <input type="text" id="newPieceTitle" placeholder="标题" ms-duplex="newTitle">
                        <div id="newPieceAlbum">
                            <div id="newPieceAlbumPreview"></div>
                        </div>
                        <div id="newPieceMenu"></div>
                        <div id="newPieceContent"></div>

                        <div id="newMetricForm">
                            <div ms-with="newMetrics" id="newMetrics">
                                <div class="row">
                                    <span class="metricInput">{{$key}}</span>
                                    <span class="metricInput">{{$val}}</span>
                                    <a class="Mbtn" ms-click="deleteMetric($key)">-</a>
                                </div>
                            </div>
                            <div>
                                <input type="text" class="metricInput" ms-duplex="_newMetric.name" placeholder="指标">
                                <input type="text" class="metricInput" ms-duplex="_newMetric.num" placeholder="值" ms-keypress="keypressMetric">
                                <a class="Mbtn" ms-click="addMetric">+</a>
                            </div>
                        </div>

                        <div class=""><a class="Mbtn" ms-click="publish">发布</a></div>
                        <!-- <div id="newPiecePreview" class="pen"></div> -->
                    </div>
                </div>
            </div>
            <div id="overview" ms-class="shortcut:viewMode=='piece'||viewMode=='newPiece'">
                <div class="MeventBrief" ms-if="!choosing">
                    <a class="title" ms-href="/event/{{id}}">{{title}}</a>
                    <div class="intro">{{content}}</div>
                </div>

                <a class="eventChange" ms-if="!choosing&&id!=null&&viewMode=='newEvent'" ms-click="loadMyEvents">选择其他事件</a>
                <div class="eventChange" ms-if="choosing">选择一个事件</div>
                <div class="Mloading" ms-if="choosing&&!myEvents.length">正在载入数据...</div>
                <div id="myEvents" ms-if="choosing" ms-each-myevent = "myEvents">
                    <div class="MeventBrief">
                        <a id="title" class"eventTitle" ms-click="loadEvent(myevent.id)">{{myevent.title}}</a>
                    </div>
                </div>

                <div id="metrics" ms-if="!choosing&&viewMode=='event'" ms-with="metrics">
                    <div class="metric" ms-class="current:currentMetric==$key" ms-click="setCurrentMetric($key)">{{$key}}</div>
                </div>

                <div id="diagramContainer" ms-if="!choosing">
                    <div id="diagram" ms-if="title">
                        <canvas id="diagramBg"></canvas>                    

                        <div id="metricLinesContainer">
                            <svg id="metricLines"></svg>
                        </div>
                        
                        <svg id="brackets" class="brackets" ms-if="currentPiece">
                            <path ms-if="currentPiece.index!=0" ms-attr-d="'M'+((currentPiece.index)*200-100)+' 550 Q'+((currentPiece.index)*200-100)+' 560 '+((currentPiece.index)*200-50)+' 560 T'+((currentPiece.index)*200)+' 570 Q'+((currentPiece.index)*200)+' 560 '+((currentPiece.index)*200+50)+' 560 T'+((currentPiece.index)*200+100)+' 550'" fill="none" stroke="#cccccc" ></path>
                            <path ms-if="!(currentPiece.index==pieces.length-1)" ms-attr-d="'M'+((currentPiece.index)*200+100)+' 550 Q'+((currentPiece.index)*200+100)+' 560 '+((currentPiece.index)*200+150)+' 560 T'+((currentPiece.index)*200+200)+' 570 Q'+((currentPiece.index)*200+200)+' 560 '+((currentPiece.index)*200+250)+' 560 T'+((currentPiece.index)*200+300)+' 550'" fill="none" stroke="#cccccc" ></path>              
                            
                        </svg>

                        <div id="pieces">
                            <div ms-each-piece="pieces"  data-each-rendered="pieceRendered">
                                <a ms-attr-id="'piece'+($index+1)" ms-data-piece="piece" class="piece" ms-mouseenter="active(piece)" ms-mouseleave="unactive" ms-attr-href="'/event/'+getEventId()+'/piece/'+piece.id">
                                    <div class="cover" ms-if="piece.cover" ><img ms-src="'http://127.0.0.1:1337/image/thumb/'+piece.cover"/></div>
                                    <div class="title">{{piece.title}}</div>
                                    <div class="text">{{piece.content|stripHTML|truncate(140,"...")}}</div>
                                    <div class="more">!</div>
                                </a>
                            </div>

                            <div id="dates" ms-each-piece="pieces">
                                <div class="time" ms-attr-style="'left:'+($index*200+50)+'px;'">{{piece.timeText}}</div>
                                <div class="time fromLast" ms-attr-style="'left:'+($index*200-50)+'px;'" ms-if='piece.fromLast'>{{piece.fromLast}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="newEvent" class="Mpage" ms-class="show:viewMode=='newEvent'" ms-controller="createEvent">
            <div id="newEventForm">
                <input type="text" id="newEventTitle" placeholder="标题" ms-duplex="newEventTitle">
                <textarea id="newEventIntro" ms-duplex="newEventIntro" placeholder="简介"></textarea>
                <div class="">
                    <a class="Mbtn" ms-class="disable:connecting" ms-click="publish">{{connecting?"保存中":"发布"}}</a>
                </div>
            </div>

        </div>

        <div id="events" class="Mpage" ms-class="show:viewMode=='all'" ms-controller="events" ms-each-event="events">
            <div class="event">
                <div><a class="eventTitle" ms-href="/event/{{event.id}}">{{event.title}}</a></div>
                <div><a class="eventIntro" ms-href="/event/listVm">{{event.content}}</a></div>
            </div>
        </div>
    </div>

    <script src="./lib/avalon.js"></script>
    <script>
    avalon.require(['../app/main'],function(app){
        app.run()
    })
    </script>
</body>
</html>